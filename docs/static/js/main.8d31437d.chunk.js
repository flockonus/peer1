(this.webpackJsonppeer1=this.webpackJsonppeer1||[]).push([[0],{10:function(e,n,o){e.exports=o(19)},15:function(e,n,o){},17:function(e,n,o){},18:function(e,n){function o(e){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}o.keys=function(){return[]},o.resolve=o,e.exports=o,o.id=18},19:function(e,n,o){"use strict";o.r(n);var t,r,c=o(0),a=o.n(c),i=o(5),s=o.n(i),l=(o(15),o(1)),u=o.n(l),f=o(2),d=o(6),p=o(7),m=o(8),g=o(9),v=(o(17),o(3)),y=o.n(v),h="peer1-registry-",w=!1,b=!1,O=!1,k=[],E={};window._peers=E;var j=function(){var e="peer1"+Math.random().toString(36).substr(2);return["localhost","127.0.0.1"].includes(window.location.hostname)?e:(localStorage.getItem("myid")||localStorage.setItem("myid",e),localStorage.getItem("myid"))}();function S(){var e=Object.freeze({peers:E,isRegistry:O,isConnRegistry:b});k.forEach((function(n){return n(e)}))}function P(){console.log("connecting to registry..");var e=setTimeout(x,5e3),n=r.connect(h,{reliable:!0});n.on("open",(function(){console.log("registryConn open"),n.send({type:"register"}),b=!0,S()})),n.on("error",(function(e){console.warn("registryConn error",e),b=!1,S()})),n.on("close",(function(){console.warn("registryConn close"),b=!1,S()})),n.on("data",(function(n){(console.log("registry says:",n),clearTimeout(e),"peerlist"===n.type)&&n.payload.ids.forEach((function(e){if(e!==r.id){console.log("calling...",e);var n=r.call(e,t);n.on("stream",(function(n){E[e]=n,S()})),n.on("close",(function(){console.log("peer close",e),delete E[e],S()})),n.on("open",(function(){}))}}))}))}function x(){console.log("becomeRegistry !");var e={},n=new y.a(h);n.on("open",(function(){console.log("registry: open \ud83e\udd16\ud83d\udcdd"),O=!0,S(),P()})),n.on("error",(function(e){console.info("registry: error",e),P()})),n.on("connection",(function(n){var o=n.peer;console.log("registry: connection",o),n.on("open",(function(){console.log("registry: conn open",o),o in e||(e[o]=n,n.send({type:"peerlist",payload:{ids:Object.keys(e)}}))})),n.on("error",(function(n){console.log("registry: conn error",o,n),delete e[o]})),n.on("close",(function(){console.log("registry: conn close",o),delete e[o]}))})),n.on("disconnected",(function(){console.log("registry: disconnected")}))}function C(){return N.apply(this,arguments)}function N(){return(N=Object(f.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",navigator.mediaDevices.getUserMedia({audio:!0,facingMode:"user",video:{width:{ideal:640},height:{ideal:480}}}).then((function(e){return e})).catch((function(e){console.error("Failed to get local stream",e)})));case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}console.log("my id is",j);var I=function(e){Object(g.a)(o,e);var n=Object(m.a)(o);function o(e){var t;Object(d.a)(this,o),t=n.call(this,e);var r=new URLSearchParams(window.location.search);return t.state={selfStream:null,roomId:r.get("room")||"default00000",peers:{}},t.initCam(),t}return Object(p.a)(o,[{key:"initCam",value:function(){var e=Object(f.a)(u.a.mark((function e(){var n,o,t=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,C();case 3:if((n=e.sent)&&n.active){e.next=6;break}throw new Error("missing stream");case 6:(o=document.querySelector(".video-self")).volume=0,o.srcObject=n,o.onloadedmetadata=function(e){o.play()},this.setState((function(e){return{selfStream:n}}),(function(){return setTimeout(t.initNetwork.bind(t),1e3*Math.random())})),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(0),console.error(e.t0);case 16:case"end":return e.stop()}}),e,this,[[0,13]])})));return function(){return e.apply(this,arguments)}}()},{key:"initNetwork",value:function(){var e=Object(f.a)(u.a.mark((function e(){var n=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=function(e){console.log("p2pState",e),n.setState({peers:e.peers})},k.push(a),e.next=3,o=this.state.roomId,c=this.state.selfStream,t=c,void(w?console.warn("P2P is already init, ignoring"):(w=!0,h+=o,r=new y.a(j),window._selfPeer=r,r.on("error",(function(e){console.warn("selfPeer error",e)})),r.on("open",(function(){console.info("selfPeer open"),P()})),r.on("call",(function(e){e.answer(t),e.on("stream",(function(n){E[e.peer]=n,S()}))})),r.on("connection",(function(e){console.log("selfPeer connection",e.peer),e.on("close",(function(){console.log("selfPeer connection close"),delete E[e.peer],S()}))}))));case 3:case"end":return e.stop()}var o,c,a}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"renderPeerVideos",value:function(e){var n=[];for(var o in e){var t=a.a.createElement("video",{key:"key-".concat(o),id:o});n.push(t)}return n}},{key:"componentDidUpdate",value:function(){var e=this,n=function(n){var o=document.getElementById(n);o.srcObject||(o.srcObject=e.state.peers[n],o.onloadedmetadata=function(e){o.play()},o.volume=0),console.log(o)};for(var o in this.state.peers)n(o)}},{key:"render",value:function(){return a.a.createElement("div",{className:"App"},a.a.createElement("header",{className:"App-header"},a.a.createElement("div",null,"HEADER"),a.a.createElement("div",null,"OHAYOOOOO"),a.a.createElement("video",{className:"video-self"},"Acquiring stream")),a.a.createElement("div",{className:"stage"},this.renderPeerVideos(this.state.peers)))}}]),o}(a.a.Component);s.a.render(a.a.createElement(I,null),document.getElementById("root"))}},[[10,1,2]]]);
//# sourceMappingURL=main.8d31437d.chunk.js.map